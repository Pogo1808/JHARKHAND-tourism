<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Johar Jharkhand - Transport Navigator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- LeafletJS and Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="httpshttps://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Lighter background */
        }
        #map {
            height: 100%;
            width: 100%;
            z-index: 0;
        }
        .leaflet-routing-container, .leaflet-control-zoom {
            display: none;
        }
        .transition-transform-opacity {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .panel-hidden {
            opacity: 0;
            transform: translateY(100%);
            pointer-events: none;
        }
        .panel-visible {
            opacity: 1;
            transform: translateY(0);
        }
        .leaflet-pane .leaflet-popup-content-wrapper {
            background: #111827;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .leaflet-pane .leaflet-popup-tip {
            background: #111827;
        }
        .ride-option-card.selected {
            border-color: #0d9488; /* Teal-600 */
            background-color: #f0fdfa; /* Teal-50 */
        }
    </style>
</head>
<body class="text-gray-900 antialiased">
    <div class="flex flex-col lg:flex-row h-screen w-full bg-gray-100">

        <!-- ===== Left Control Panel (Desktop) ===== -->
        <div class="hidden lg:flex w-full lg:w-[400px] flex-col shadow-lg z-20 bg-white">
            <div id="desktop-panel-content" class="flex flex-col h-full">
                <!-- Desktop Search Panel is dynamically rendered here -->
            </div>
        </div>

        <!-- ===== Main Map and UI Area ===== -->
        <div class="flex-grow h-full relative">
            <div id="map"></div>
            
            <!-- Floating Search Bar (Mobile) -->
            <div id="floating-search-bar" class="lg:hidden absolute top-4 left-4 right-4 z-10">
                <button id="open-search-panel-btn" class="w-full flex items-center bg-white p-3 rounded-xl shadow-lg">
                    <i class="fas fa-search text-gray-400"></i>
                    <span class="ml-3 text-gray-500">Where to?</span>
                </button>
            </div>

            <!-- Floating Action Buttons -->
            <div class="absolute bottom-6 right-4 flex flex-col items-center space-y-3 z-10">
                <button class="w-14 h-14 bg-red-600 text-white rounded-full flex items-center justify-center shadow-lg font-bold text-lg hover:bg-red-700 transition">SOS</button>
                <button id="chatbot-btn" class="w-14 h-14 bg-white text-teal-600 rounded-full flex items-center justify-center shadow-lg hover:bg-gray-200 transition">
                     <i class="fas fa-robot text-2xl"></i>
                </button>
            </div>

            <!-- Mobile Panels Container -->
            <div id="mobile-panels-container" class="lg:hidden">
                <!-- Search Panel (Mobile) -->
                <div id="search-panel" class="transition-transform-opacity panel-hidden fixed inset-0 bg-white z-30 flex flex-col">
                    <!-- Dynamic content will be injected -->
                </div>
                
                <!-- Results Panel (Mobile) -->
                <div id="results-panel" class="transition-transform-opacity panel-hidden fixed bottom-0 left-0 right-0 h-[60%] bg-white z-40 rounded-t-2xl shadow-[0_-10px_30px_rgba(0,0,0,0.1)] flex flex-col">
                    <!-- Dynamic content will be injected -->
                </div>
            </div>

             <!-- Chatbot Modal -->
            <div id="chatbot-modal" class="transition-transform-opacity panel-hidden fixed inset-0 lg:inset-auto lg:top-20 lg:right-5 w-full h-full lg:w-96 lg:h-[600px] bg-white flex flex-col z-40 rounded-none lg:rounded-xl shadow-2xl">
                 <!-- Chatbot content is injected here -->
            </div>
        </div>
        
        <!-- Global Message Modal -->
        <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div class="relative p-5 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <div class="mt-3 text-center">
              <div id="modal-icon-container" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                   <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
              </div>
              <h3 class="text-lg leading-6 font-bold text-gray-900 mt-4" id="modal-title">Error</h3>
              <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-600" id="modal-message"></p>
              </div>
              <div class="items-center px-4 py-3">
                <button id="modal-close" class="px-6 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // UI Panels & Elements
            const desktopPanel = document.getElementById('desktop-panel-content');
            const searchPanel = document.getElementById('search-panel');
            const resultsPanel = document.getElementById('results-panel');
            const chatbotModal = document.getElementById('chatbot-modal');
            const openSearchPanelBtn = document.getElementById('open-search-panel-btn');

            // Global error modal
            const modal = document.getElementById('message-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalClose = document.getElementById('modal-close');

            // Map variables
            let map;
            let startMarker, endMarker;
            let routingControl;
            const initialCoords = [23.6345, 85.3847]; // Jharkhand center
            const initialZoom = 7;
            
            // --- UI Controls ---
            const showPanel = (panelEl) => panelEl.classList.replace('panel-hidden', 'panel-visible');
            const hidePanel = (panelEl) => panelEl.classList.replace('panel-visible', 'panel-hidden');
            
            openSearchPanelBtn.addEventListener('click', () => showPanel(searchPanel));

            function showMessage(title, message, isSuccess = false) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                const iconContainer = document.getElementById('modal-icon-container');
                const closeBtn = document.getElementById('modal-close');

                if (isSuccess) {
                    iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100';
                    iconContainer.innerHTML = '<i class="fas fa-check text-green-600 text-2xl"></i>';
                    closeBtn.className = 'px-6 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300';
                } else {
                    iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100';
                    iconContainer.innerHTML = '<i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>';
                    closeBtn.className = 'px-6 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300';
                }
                modal.classList.remove('hidden');
            }
            modalClose.addEventListener('click', () => modal.classList.add('hidden'));

            // --- Map Initialization ---
            map = L.map('map').setView(initialCoords, initialZoom);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);

            // --- Templates ---
            const getSearchPanelHTML = (isMobile) => `
                <header class="p-4 flex items-center space-x-3 flex-shrink-0">
                    ${isMobile ? `<button class="close-search-panel-btn text-gray-600"><i class="fas fa-arrow-left text-xl"></i></button>` : ''}
                    <h1 class="text-xl font-bold text-gray-800">Plan Your Trip</h1>
                </header>
                <div class="p-4 flex-grow">
                    <div class="space-y-4">
                        <div class="relative">
                            <label for="start-location-input" class="text-xs font-bold text-gray-500 px-1">FROM</label>
                            <input id="start-location-input" type="text" placeholder="e.g., Ranchi Station" class="w-full bg-gray-100 border-2 border-gray-200 rounded-lg py-3 pl-10 pr-4 focus:outline-none focus:border-teal-500 mt-1">
                            <i class="fas fa-circle text-teal-500 absolute left-4 top-10"></i>
                        </div>
                        <div class="relative">
                            <label for="destination-input" class="text-xs font-bold text-gray-500 px-1">TO</label>
                            <input id="destination-input" type="text" placeholder="e.g., Dassam Falls" class="w-full bg-gray-100 border-2 border-gray-200 rounded-lg py-3 pl-10 pr-4 focus:outline-none focus:border-teal-500 mt-1">
                            <i class="fas fa-map-marker-alt text-red-500 absolute left-4 top-10"></i>
                        </div>
                    </div>
                </div>
                <footer class="p-4 flex-shrink-0">
                    <button class="search-route-btn w-full bg-teal-600 text-white font-bold py-3.5 rounded-xl hover:bg-teal-700 transition flex items-center justify-center">
                        <i class="fas fa-search mr-2"></i> Find Route
                    </button>
                </footer>`;

            const getResultsPanelHTML = (isMobile) => `
                <header class="p-4 flex items-center space-x-3 flex-shrink-0 border-b">
                    ${isMobile ? `<button class="back-to-search-btn text-gray-600"><i class="fas fa-arrow-left text-xl"></i></button>` : ''}
                    <div class="truncate">
                         <p class="ride-origin-text text-xs text-gray-500 truncate">Origin</p>
                         <h2 class="ride-dest-text font-bold text-gray-800 truncate">Destination</h2>
                    </div>
                </header>
                <div class="ride-options-results p-4 flex-grow overflow-y-auto bg-gray-50">
                     <div class="text-center py-8"><i class="fas fa-spinner fa-spin text-teal-500 text-3xl"></i><p class="mt-2 text-gray-500">Calculating routes...</p></div>
                </div>
                <footer class="p-4 bg-white border-t flex-shrink-0">
                    <button class="confirm-booking-btn w-full bg-teal-600 text-white font-bold py-3.5 rounded-xl hover:bg-teal-700 transition">Confirm Booking</button>
                </footer>`;

            const getChatbotHTML = () => `
                <header class="p-4 flex items-center justify-between bg-white shadow-sm flex-shrink-0 rounded-t-none lg:rounded-t-xl">
                    <h2 class="text-lg font-bold text-gray-800">AI Guide Bot</h2>
                    <button class="close-chatbot-btn text-gray-600"><i class="fas fa-times text-xl"></i></button>
                </header>
                <div class="flex-grow p-4 overflow-y-auto flex flex-col space-y-4">
                    <div id="ai-recommendations">
                         <h3 class="text-md font-semibold mb-2 text-gray-700">AI Recommendations</h3>
                         <div id="recommendation-content" class="bg-teal-50 border-l-4 border-teal-500 text-teal-900 p-3 rounded-r-lg text-sm">
                            <p>Search for a destination to get personalized travel suggestions!</p>
                         </div>
                    </div>
                    <div id="chat-container" class="border border-gray-200 rounded-lg flex-grow flex flex-col">
                        <div id="chat-window" class="flex-grow p-3 overflow-y-auto">
                            <div class="text-sm p-2 rounded-lg bg-gray-100 w-fit max-w-[80%]">Ask me anything about Jharkhand tourism!</div>
                        </div>
                        <div class="flex border-t">
                            <input type="text" id="chat-input" class="w-full p-3 border-0 focus:ring-0" placeholder="Ask a question...">
                            <button id="chat-send" class="bg-teal-600 text-white px-5 hover:bg-teal-700"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>`;
            
            // --- Logic Functions ---
            let activeUI = 'search';

            function setupEventListeners() {
                document.querySelectorAll('.close-search-panel-btn').forEach(btn => btn.addEventListener('click', () => hidePanel(searchPanel)));
                document.querySelectorAll('.search-route-btn').forEach(btn => btn.addEventListener('click', performSearch));
                document.querySelectorAll('.back-to-search-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (window.innerWidth < 1024) { // Mobile
                           hidePanel(resultsPanel);
                           showPanel(searchPanel);
                        } else { // Desktop
                           renderDesktopSearch();
                        }
                         if (routingControl) map.removeControl(routingControl);
                         if (startMarker) map.removeLayer(startMarker);
                         if (endMarker) map.removeLayer(endMarker);
                         map.setView(initialCoords, initialZoom);
                    });
                });
                document.querySelectorAll('.confirm-booking-btn').forEach(btn => btn.addEventListener('click', () => showMessage('Booking', 'This is a demo. Booking feature is not implemented.', true)));
                
                document.querySelectorAll('#start-location-input, #destination-input').forEach(input => {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') performSearch();
                    });
                });
            }

            function setupChatbotListeners() {
                document.getElementById('chatbot-btn').addEventListener('click', () => showPanel(chatbotModal));
                document.querySelector('.close-chatbot-btn').addEventListener('click', () => hidePanel(chatbotModal));
                document.getElementById('chat-send').addEventListener('click', handleChat);
                document.getElementById('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleChat(); });
            }

            async function performSearch() {
                const startQuery = document.getElementById('start-location-input').value.trim();
                const destQuery = document.getElementById('destination-input').value.trim();

                if (!startQuery || !destQuery) {
                    showMessage('Input Error', 'Please enter both a starting location and a destination.');
                    return;
                }
                
                renderResultsPanel(startQuery, destQuery);
                
                try {
                    const [startCoords, destCoords] = await Promise.all([geocodeLocation(startQuery), geocodeLocation(destQuery)]);

                    if (!startCoords) throw new Error(`Could not find starting location: "${startQuery}".`);
                    if (!destCoords) throw new Error(`Could not find destination: "${destQuery}".`);

                    if (routingControl) map.removeControl(routingControl);
                    if (startMarker) map.removeLayer(startMarker);
                    if (endMarker) map.removeLayer(endMarker);
                    
                    startMarker = L.marker([startCoords.lat, startCoords.lon]).addTo(map).bindPopup(`<b>Start:</b> ${startQuery}`);
                    endMarker = L.marker([destCoords.lat, destCoords.lon]).addTo(map).bindPopup(`<b>Destination:</b> ${destQuery}`);
                    map.fitBounds(L.latLngBounds(startMarker.getLatLng(), endMarker.getLatLng()), { padding: [50, 50] });

                    routingControl = L.Routing.control({
                        waypoints: [L.latLng(startCoords.lat, startCoords.lon), L.latLng(destCoords.lat, destCoords.lon)],
                        routeWhileDragging: false, show: false, addWaypoints: false,
                        lineOptions: { styles: [{color: '#14b8a6', opacity: 0.8, weight: 6}] },
                        createMarker: () => null
                    }).on('routesfound', (e) => {
                        const summary = e.routes[0].summary;
                        const distance = (summary.totalDistance / 1000).toFixed(1);
                        const duration = Math.round(summary.totalTime / 60);
                        displayRideOptions(distance, duration);
                    }).addTo(map);
                    
                    getAIRecommendations(destQuery);
                } catch (err) {
                    showMessage('Search Error', err.message);
                    renderDesktopSearch(); // Reset desktop panel on error
                }
            }
            
            async function geocodeLocation(query) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=in&viewbox=83.3,21.9,87.9,25.3&bounded=1`);
                    const data = await response.json();
                    return data.length > 0 ? data[0] : null;
                } catch (err) { return null; }
            }

            function displayRideOptions(distance, carDuration) {
                 const formatDuration = (totalMinutes) => {
                    const h = Math.floor(totalMinutes / 60);
                    const m = Math.round(totalMinutes % 60);
                    return `${h > 0 ? h + 'h ' : ''}${m}m`;
                };

                const options = [
                    { type: 'Taxi (Sedan)', icon: 'fa-car-side', price: (distance * 15 + 50), duration: carDuration, color: 'blue' },
                    { type: 'Auto-Rickshaw', icon: 'fa-car-rear', price: (distance * 12 + 40), duration: carDuration * 1.2, color: 'amber' },
                    { type: 'E-Rickshaw', icon: 'fa-shuttle-van', price: (distance * 10 + 30), duration: carDuration * 1.4, color: 'emerald' },
                ];
                
                let optionsHTML = '<div class="space-y-3">';
                options.forEach((opt, index) => {
                    optionsHTML += `
                        <div class="ride-option-card p-3 bg-white rounded-xl border-2 border-transparent hover:border-teal-300 transition cursor-pointer ${index === 0 ? 'selected' : ''}">
                           <div class="flex items-center">
                               <i class="fas ${opt.icon} text-2xl text-${opt.color}-500 w-10 text-center"></i>
                               <div class="ml-3 flex-grow">
                                   <h4 class="font-bold text-gray-800">${opt.type}</h4>
                                   <p class="text-xs text-gray-500">${formatDuration(opt.duration)}</p>
                               </div>
                               <div class="text-right">
                                   <p class="font-bold text-lg text-gray-900">â‚¹${Math.round(opt.price)}</p>
                                   <p class="text-xs text-gray-500">${distance} km</p>
                               </div>
                           </div>
                        </div>`;
                });
                optionsHTML += '</div>';
                
                document.querySelectorAll('.ride-options-results').forEach(el => el.innerHTML = optionsHTML);

                document.querySelectorAll('.ride-option-card').forEach(card => {
                    card.addEventListener('click', () => {
                        document.querySelectorAll('.ride-option-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                    });
                });
            }

            function getAIRecommendations(destination) {
                const recText = `Based on your interest in <b>${destination}</b>, you might also like:
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li><b>Dassam Falls:</b> A stunning natural waterfall.</li>
                        <li><b>Birsa Zoological Park:</b> Great for wildlife enthusiasts.</li>
                    </ul>`;
                document.querySelectorAll('#recommendation-content').forEach(el => el.innerHTML = recText);
            }

             function handleChat() {
                const chatWindow = document.getElementById('chat-window');
                const chatInput = document.getElementById('chat-input');
                const userInput = chatInput.value.trim();
                if(!userInput) return;
                
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'text-sm p-2 rounded-lg mb-2 w-fit max-w-[80%] bg-teal-600 text-white self-end';
                userMessageDiv.textContent = userInput;
                chatWindow.appendChild(userMessageDiv);
                chatInput.value = '';
                chatWindow.scrollTop = chatWindow.scrollHeight;

                setTimeout(() => {
                    let botResponse = "I am a demo bot. For real-time info on <b>Ranchi</b>, <b>Parasnath Hills</b>, or local <b>food</b>, just ask!";
                    if (userInput.toLowerCase().includes('ranchi')) botResponse = "Ranchi is famous for its waterfalls! You must visit <b>Hundru</b>, <b>Jonha</b>, and <b>Dassam Falls</b>.";
                    else if (userInput.toLowerCase().includes('food')) botResponse = "Jharkhand's cuisine is a must-try! Ask for <b>Dhuska</b>, <b>Litti Chokha</b>, and <b>Thekua</b>.";
                    
                    const botMessageDiv = document.createElement('div');
                    botMessageDiv.className = 'text-sm p-2 rounded-lg mb-2 w-fit max-w-[80%] bg-gray-100';
                    botMessageDiv.innerHTML = botResponse;
                    chatWindow.appendChild(botMessageDiv);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }, 800);
            }

            // --- Initial Render ---
            function renderDesktopSearch() {
                desktopPanel.innerHTML = getSearchPanelHTML(false);
                setupEventListeners();
                activeUI = 'search';
            }

            function renderResultsPanel(start, dest) {
                if (window.innerWidth < 1024) { // Mobile
                    hidePanel(searchPanel);
                    resultsPanel.innerHTML = getResultsPanelHTML(true);
                    showPanel(resultsPanel);
                } else { // Desktop
                    desktopPanel.innerHTML = getResultsPanelHTML(false);
                }
                document.querySelectorAll('.ride-origin-text').forEach(el => el.textContent = start);
                document.querySelectorAll('.ride-dest-text').forEach(el => el.textContent = dest);
                setupEventListeners();
                activeUI = 'results';
            }

            function initializeUI() {
                // Desktop
                renderDesktopSearch();
                // Mobile
                searchPanel.innerHTML = getSearchPanelHTML(true);
                setupEventListeners();
                // Chatbot
                chatbotModal.innerHTML = getChatbotHTML();
                setupChatbotListeners();
            }

            initializeUI();
        });
    </script>
</body>
</html>